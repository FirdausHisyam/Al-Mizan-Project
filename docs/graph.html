<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Al-Mizan | Epistemic Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mizan-gold': '#d4af37',
                        'mizan-dark': '#0f172a',
                        'mizan-green': '#064e3b',
                        'parchment': '#fdfbf7',
                    },
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'amiri': ['Amiri', 'serif'],
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #fdfbf7;
            background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px), radial-gradient(#d4af37 0.5px, #fdfbf7 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            background-attachment: fixed;
            overflow: hidden;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .node-label-ar { font-family: 'Amiri', serif; }
        
        /* Animation for Dalil Tracing */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }
        
        .pulse-active {
            animation: pulse-gold 2s infinite;
        }
    </style>
</head>
<body class="text-slate-800 font-inter h-screen flex flex-col">

    <nav class="glass-panel z-50 px-6 py-3 flex justify-between items-center border-b border-mizan-gold/20">
        <div class="flex items-center gap-3">
            <a href="index.html" class="flex items-center gap-2 text-slate-800 hover:text-mizan-gold transition">
                <i class="fas fa-home"></i> <span class="font-cinzel font-bold">Al-Mizan</span>
            </a>
            <span class="text-slate-300">|</span>
            <span class="font-bold text-slate-600 text-mizan-gold">Architect</span>
        </div>
        
        <div class="flex gap-4 text-sm font-medium mr-auto ml-8">
            <a href="engine.html" class="text-slate-600 hover:text-blue-600 transition">Certainty Engine</a>
            <a href="strategy.html" class="text-slate-600 hover:text-amber-600 transition">Strategy</a>
            <a href="citadel.html" class="text-slate-600 hover:text-emerald-600 transition">Citadel Ops</a>
        </div>

        <div class="flex gap-2">
            <button onclick="setMode('organic')" class="px-3 py-1.5 text-xs font-bold rounded-md bg-white border border-slate-200 hover:bg-slate-50 transition shadow-sm">
                <i class="fas fa-project-diagram mr-1"></i> Organic
            </button>
            <button onclick="setMode('hierarchical')" class="px-3 py-1.5 text-xs font-bold rounded-md bg-mizan-dark text-white hover:bg-slate-800 transition shadow-sm border border-transparent">
                <i class="fas fa-sitemap mr-1 text-mizan-gold"></i> Epistemic Order
            </button>
        </div>
    </nav>

    <div class="flex-1 relative flex overflow-hidden">
        
        <aside class="w-80 glass-panel border-r border-mizan-gold/20 flex flex-col z-40 transition-all duration-300 absolute h-full left-0 md:relative" id="sidebar">
            
            <div class="p-4 border-b border-slate-100">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                    <input list="nodesList" id="searchNode" onchange="focusNode(this.value)" placeholder="Search the Graph..." 
                        class="w-full pl-9 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-mizan-gold/50 transition shadow-sm">
                    <datalist id="nodesList"></datalist>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <div class="bg-gradient-to-br from-slate-50 to-white p-4 rounded-xl border border-indigo-100 shadow-sm relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-8 -mt-8 transition-all group-hover:bg-indigo-100"></div>
                    
                    <h2 class="text-xs font-bold uppercase tracking-wider mb-3 text-indigo-700 flex items-center gap-2 relative z-10">
                        <i class="fas fa-sparkles"></i> AI Architect
                    </h2>
                    
                    <div class="space-y-2 relative z-10">
                        <input type="text" id="aiTopicInput" placeholder="e.g. 'Riba in Fintech'" 
                            class="w-full border border-slate-200 rounded-md p-2 text-xs focus:border-indigo-400 focus:outline-none">
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="generateSubgraph()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded-md text-xs font-bold transition flex items-center justify-center gap-1">
                                <span>Generate</span>
                            </button>
                            <button onclick="aiSimulateThinking()" class="bg-white border border-indigo-200 text-indigo-700 hover:bg-indigo-50 py-1.5 rounded-md text-xs font-bold transition">
                                Suggest
                            </button>
                        </div>
                    </div>

                    <div id="aiLoading" class="hidden mt-3 text-center">
                        <div class="flex items-center justify-center gap-2 text-indigo-600">
                            <i class="fas fa-circle-notch fa-spin text-sm"></i>
                            <span class="text-xs font-mono animate-pulse">Consulting Scholars...</span>
                        </div>
                    </div>
                </div>

                <div id="selection-details" class="hidden animate-fade-in-up">
                    <div class="bg-emerald-50/50 border border-emerald-100 rounded-xl p-4 relative">
                        <button onclick="closeSelection()" class="absolute top-2 right-2 text-emerald-400 hover:text-emerald-700"><i class="fas fa-times"></i></button>
                        
                        <span class="text-[10px] font-bold tracking-widest text-emerald-600 uppercase mb-1 block">Selected Node</span>
                        <h3 id="sel-label" class="font-cinzel font-bold text-slate-800 text-lg leading-tight">Concept</h3>
                        <p id="sel-arabic" class="font-amiri text-xl text-emerald-700 mt-1 mb-2"></p>
                        
                        <div class="flex flex-wrap gap-1 mb-3" id="sel-badges">
                            </div>

                        <p id="sel-desc" class="text-xs text-slate-600 leading-relaxed mb-3 border-t border-emerald-100 pt-2"></p>

                        <button onclick="traceDalil()" class="w-full bg-white border border-emerald-200 text-emerald-800 hover:bg-emerald-100 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-sm transition group">
                            <i class="fas fa-route group-hover:text-emerald-600"></i> Trace Dalil (Authority)
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Ontology Legend</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="flex items-center gap-2 p-1.5 bg-white rounded border border-slate-100">
                            <div class="w-2.5 h-2.5 rounded-full bg-black"></div>
                            <span class="text-[10px] font-bold text-slate-600">Divine</span>
                        </div>
                        <div class="flex items-center gap-2 p-1.5 bg-white rounded border border-slate-100">
                            <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                            <span class="text-[10px] font-bold text-slate-600">Wahi</span>
                        </div>
                        <div class="flex items-center gap-2 p-1.5 bg-white rounded border border-slate-100">
                            <div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>
                            <span class="text-[10px] font-bold text-slate-600">Usul</span>
                        </div>
                        <div class="flex items-center gap-2 p-1.5 bg-white rounded border border-slate-100">
                            <div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                            <span class="text-[10px] font-bold text-slate-600">Fiqh</span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50/50 flex gap-2">
                <button onclick="exportImage()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium transition">
                    <i class="fas fa-camera mr-1"></i> Capture
                </button>
                <button onclick="resetGraph()" class="flex-1 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium transition">
                    <i class="fas fa-expand mr-1"></i> Reset
                </button>
            </div>
        </aside>

        <main class="flex-1 relative bg-parchment/50" id="mynetwork">
            <div id="initial-loader" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-parchment transition-opacity duration-700">
                <div class="text-4xl text-mizan-gold mb-4"><i class="fas fa-circle-notch fa-spin"></i></div>
                <div class="font-cinzel font-bold text-slate-800">Initializing Knowledge Graph</div>
                <div class="font-amiri text-slate-500 mt-2">بسم الله الرحمن الرحيم</div>
            </div>
        </main>

        <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')" class="md:hidden absolute bottom-6 right-6 z-50 bg-mizan-dark text-white p-4 rounded-full shadow-xl">
            <i class="fas fa-bars"></i>
        </button>

    </div>

    <script>
        // --- Data & Ontology ---
        
        // Extended Node Data to look "Impressive"
        const rawNodes = [
            { id: 0, label: 'Allah', arabic: 'الله', group: 'divine', status: 'Absolute', title: 'The Ultimate Source of Legislation' },
            { id: 1, label: 'Quran', arabic: 'القرآن', group: 'wahi', status: 'Qat\'i', title: 'The Recited Revelation' },
            { id: 2, label: 'Sunnah', arabic: 'السنة', group: 'sunnah', status: 'Wahi', title: 'The Prophetic Example' },
            { id: 3, label: 'Usul al-Fiqh', arabic: 'أصول الفقه', group: 'usul', status: 'Thabit', title: 'Principles of Jurisprudence' },
            { id: 4, label: 'Ijma', arabic: 'الإجماع', group: 'usul', status: 'Thabit', title: 'Scholarly Consensus' },
            { id: 5, label: 'Qiyas', arabic: 'القياس', group: 'usul', status: 'Zanni', title: 'Analogical Deduction' },
            { id: 6, label: 'Maqasid', arabic: 'المقاصد', group: 'maqasid', status: 'Thabit', title: 'Higher Objectives' },
            { id: 7, label: 'Hifz al-Mal', arabic: 'حفظ المال', group: 'maqasid', status: 'Thabit', title: 'Protection of Wealth' },
            { id: 8, label: 'Riba', arabic: 'الربا', group: 'fiqh', status: 'Haram', title: 'Usury / Interest' },
            { id: 9, label: 'Gharar', arabic: 'الغرر', group: 'fiqh', status: 'Haram', title: 'Excessive Uncertainty' },
            { id: 10, label: 'Crypto', arabic: 'العملات الرقمية', group: 'modern', status: 'Mutaghayyir', title: 'Digital Assets' },
            { id: 11, label: 'Gold', arabic: 'الذهب', group: 'fiqh', status: 'Thabit', title: 'Commodity Money' },
            { id: 12, label: 'Imam Shafi\'i', arabic: 'الشافعي', group: 'scholar', status: 'Mujtahid', title: 'Founder of Shafi\'i School' },
            { id: 13, label: 'Verse 2:275', arabic: 'آية الربا', group: 'wahi', status: 'Qat\'i', title: 'Ayat al-Riba' },
            { id: 14, label: 'Istihsan', arabic: 'الاستحسان', group: 'usul', status: 'Zanni', title: 'Juristic Preference' },
            { id: 15, label: 'Maslahah', arabic: 'المصلحة المرسلة', group: 'usul', status: 'Zanni', title: 'Public Interest' },
        ];

        const rawEdges = [
            { from: 0, to: 1, label: 'reveals' }, { from: 0, to: 2, label: 'inspires' },
            { from: 1, to: 3, label: 'grounds' }, { from: 2, to: 3, label: 'grounds' },
            { from: 3, to: 4, label: 'validates' }, { from: 3, to: 5, label: 'defines' },
            { from: 3, to: 6, label: 'serves' }, { from: 6, to: 7, label: 'includes' },
            { from: 13, to: 8, label: 'prohibits' }, { from: 1, to: 13, label: 'contains' },
            { from: 3, to: 8, label: 'derives' }, { from: 7, to: 8, label: 'contradicts' },
            { from: 7, to: 9, label: 'contradicts' },
            { from: 8, to: 10, label: 'applies_to?' }, // Question mark implies ongoing ijtihad
            { from: 11, to: 1, label: 'mentioned_in' },
            { from: 12, to: 3, label: 'codified' },
            { from: 12, to: 4, label: 'prioritized' },
            { from: 3, to: 14, label: 'mechanism' }, { from: 3, to: 15, label: 'mechanism' }
        ];

        // --- Configuration ---
        
        function getGroupStyle(group) {
            const styles = {
                divine: { color: '#0f172a', shape: 'dot', size: 40, icon: '\uf6a0' }, // Kaaba icon lookalike or similar
                wahi: { color: '#d97706', shape: 'dot', size: 30, icon: '\uf518' }, // Book
                sunnah: { color: '#059669', shape: 'dot', size: 30, icon: '\uf552' }, // Feather
                usul: { color: '#2563eb', shape: 'diamond', size: 25 },
                fiqh: { color: '#64748b', shape: 'box', size: 20 },
                maqasid: { color: '#7c3aed', shape: 'hexagon', size: 25 },
                scholar: { color: '#be123c', shape: 'star', size: 30 },
                modern: { color: '#0891b2', shape: 'box', size: 20 }
            };
            return styles[group] || styles.fiqh;
        }

        const nodes = new vis.DataSet(rawNodes.map(n => {
            const style = getGroupStyle(n.group);
            return {
                id: n.id,
                label: n.label,
                group: n.group,
                title: n.title, // tooltip
                arabic: n.arabic,
                status: n.status,
                color: { background: style.color, border: style.color, highlight: { border: '#d4af37', background: style.color } },
                shape: style.shape,
                font: { 
                    color: n.group === 'divine' ? '#d4af37' : '#334155', 
                    face: 'Inter', 
                    size: 14, 
                    strokeWidth: 4, 
                    strokeColor: '#ffffff',
                    background: '#fdfbf7' // Parchment background for labels preventing overlap
                },
                borderWidth: 2,
                shadow: { enabled: true, color: 'rgba(0,0,0,0.1)', size: 10, x: 5, y: 5 }
            };
        }));

        const edges = new vis.DataSet(rawEdges.map(e => ({
            ...e,
            arrows: 'to',
            color: { color: '#cbd5e1', highlight: '#d4af37' },
            width: 1.5,
            smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 }
        })));

        let network = null;
        let currentLayout = 'organic';

        function init() {
            const container = document.getElementById('mynetwork');
            const data = { nodes: nodes, edges: edges };
            
            // Optimized Options (Silky Smooth)
            const options = {
                nodes: {
                    shape: 'dot',
                    font: {
                        size: 16,
                        face: 'Inter',
                        strokeWidth: 3,
                        multi: 'html',
                        // multi font logic is specific to Vis.js if enabled, but we use simple styling here
                    },
                    scaling: {
                        min: 10,
                        max: 30,
                    }
                },
                edges: {
                    width: 2,
                    smooth: {
                        type: 'continuous',
                        forceDirection: 'none',
                        roundness: 0.5
                    },
                    color: { inherit: 'from' }
                },
                physics: {
                    enabled: true,
                    solver: 'barnesHut', 
                    barnesHut: {
                        gravitationalConstant: -3000,
                        centralGravity: 0.1, // Low gravity = organic drift
                        springLength: 180, // Long springs
                        springConstant: 0.01, // Very soft springs = floaty
                        damping: 0.3, // Stable but not sluggish
                        avoidOverlap: 1 // Maximize overlap avoidance
                    },
                    stabilization: {
                        enabled: true,
                        iterations: 1000,
                        updateInterval: 25,
                        onlyDynamicEdges: false,
                        fit: true
                    },
                    adaptiveTimestep: true 
                },
                interaction: { 
                    hover: true, 
                    tooltipDelay: 200, 
                    hideEdgesOnDrag: false, // User prefers smoothness over raw speed
                    hideNodesOnDrag: false,
                    keyboard: true,
                    navigationButtons: true
                },
                layout: {
                    improvedLayout: true
                }
            };

            network = new vis.Network(container, data, options);

            // Events
            network.on("click", handleSelect);
            
            network.on("stabilizationIterationsDone", () => {
                const loader = document.getElementById('initial-loader');
                if(loader) {
                    loader.classList.add('opacity-0');
                    setTimeout(() => loader.remove(), 800);
                }
                
                // Initial Camera Move for aesthetic entry
                network.fit({
                    animation: {
                        duration: 1500,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            });
            
            updateSearchList();
        }

        // --- Interaction Logic ---

        function handleSelect(params) {
            const selDiv = document.getElementById('selection-details');
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                
                selDiv.classList.remove('hidden');
                document.getElementById('sel-label').innerText = node.label;
                document.getElementById('sel-arabic').innerText = node.arabic || '';
                document.getElementById('sel-desc').innerText = node.title;
                
                // Badges
                const badges = document.getElementById('sel-badges');
                badges.innerHTML = `
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-100 text-slate-500 border border-slate-200">${node.group}</span>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${['Qat\'i','Thabit','Absolute'].includes(node.status) ? 'bg-red-50 text-red-600 border-red-100' : 'bg-blue-50 text-blue-600 border-blue-100'} border">${node.status}</span>
                `;

                // Focus camera
                network.focus(nodeId, { scale: 1.2, animation: { duration: 500, easingFunction: 'easeInOutQuad' } });

            } else {
                closeSelection();
            }
        }

        function closeSelection() {
            document.getElementById('selection-details').classList.add('hidden');
            network.unselectAll();
        }

        function focusNode(label) {
            const node = nodes.get().find(n => n.label.toLowerCase() === label.toLowerCase());
            if (node) {
                network.selectNodes([node.id]);
                handleSelect({ nodes: [node.id] });
            }
        }

        function updateSearchList() {
            const list = document.getElementById('nodesList');
            list.innerHTML = '';
            nodes.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.label;
                list.appendChild(opt);
            });
        }

        // --- The "Impressive" Features ---

        // 1. Layout Switching (Epistemic Order)
        function setMode(mode) {
            if (mode === currentLayout) return;
            currentLayout = mode;

            if (mode === 'hierarchical') {
                network.setOptions({
                    physics: { enabled: false }, 
                    layout: {
                        hierarchical: {
                            enabled: true,
                            direction: 'UD', 
                            sortMethod: 'directed',
                            levelSeparation: 150,
                            nodeSpacing: 150
                        }
                    }
                });
                network.fit({ animation: true });
            } else {
                // Return to Organic: Re-enable physics explicitly
                network.setOptions({
                    physics: { enabled: true },
                    layout: { hierarchical: { enabled: false } }
                });
                // Give it a kick to rearrange
                network.startSimulation(); 
            }
        }

        // 2. Trace Dalil (Animated)
        function traceDalil() {
            const selection = network.getSelectedNodes();
            if (selection.length === 0) return;
            const startId = selection[0];

            // BFS for path to root (ID 0)
            const queue = [[startId]];
            const visited = new Set([startId]);
            let path = null;

            // Note: In graph theory, we are looking for ancestors, so we traverse incoming edges
            // But VisJS edges are directed. We need to find nodes where 'to' == current.
            
            while(queue.length > 0) {
                const currentPath = queue.shift();
                const currNode = currentPath[currentPath.length-1];
                
                if(currNode === 0) { // Found Allah node
                    path = currentPath; 
                    break;
                }

                // Find parents (nodes that point TO current)
                const parents = edges.get().filter(e => e.to === currNode).map(e => e.from);
                
                for(let p of parents) {
                    if(!visited.has(p)) {
                        visited.add(p);
                        queue.push([...currentPath, p]);
                    }
                }
            }

            if(path) {
                // Animate the path from Root DOWN to Node
                path.reverse(); // Now it's [0, 1, ..., Target]
                
                let i = 0;
                function highlightStep() {
                    if (i >= path.length) return;
                    
                    const nodeId = path[i];
                    network.selectNodes([nodeId]);
                    
                    // Flash effect
                    // (In a real app, we'd swap the color, but VisJS update is simple)
                    const node = nodes.get(nodeId);
                    const originalColor = node.color.background;
                    
                    nodes.update({ id: nodeId, color: { background: '#d4af37', border: '#fff' } });
                    
                    if (i > 0) {
                        // Highlight edge connecting prev to curr
                        const prev = path[i-1];
                        const edge = edges.get().find(e => e.from === prev && e.to === nodeId);
                        if(edge) edges.update({ id: edge.id, color: { color: '#d4af37', width: 4 } });
                    }

                    setTimeout(() => {
                        nodes.update({ id: nodeId, color: { background: originalColor } }); // Revert
                        i++;
                        requestAnimationFrame(highlightStep);
                    }, 600);
                }
                
                highlightStep();
                
            } else {
                alert("No direct Isnad (chain) found linking this concept to the Divine source in this subgraph.");
            }
        }

        // 3. AI Simulation (Mock for Demo)
        function generateSubgraph() {
            const topic = document.getElementById('aiTopicInput').value;
            if(!topic) return;

            const loader = document.getElementById('aiLoading');
            loader.classList.remove('hidden');

            // Simulate API latency
            setTimeout(() => {
                loader.classList.add('hidden');
                
                // Demo: Add dummy nodes related to topic
                const baseId = Math.floor(Math.random() * 1000);
                const newNodes = [
                    { id: baseId, label: topic, group: 'modern', status: 'Jadid', title: 'New Issue' },
                    { id: baseId+1, label: 'Fatwa Council', group: 'scholar', status: 'Zanni', title: 'Contemporary Ijtihad' },
                    { id: baseId+2, label: 'Maslahah', group: 'usul', status: 'Thabit', title: 'Public Good' }
                ];
                
                // Add and link
                nodes.add(newNodes.map(n => {
                    const s = getGroupStyle(n.group);
                    return { ...n, color: { background: s.color, border: s.color }, shape: s.shape, font: {color:'#333'} };
                }));

                edges.add([
                    { from: baseId+1, to: baseId, label: 'rules_on' },
                    { from: baseId+2, to: baseId+1, label: 'guides' }
                ]);

                // Connect to existing graph (Temporary/Proposed Link)
                // Find a logical parent (e.g. Usul or Fiqh)
                let parentNode = nodes.get().find(n => n.group === 'usul' || n.group === 'fiqh');
                if(!parentNode) parentNode = nodes.get(3); // Default to Usul al-Fiqh if search fails

                if(parentNode) {
                    edges.add({ 
                        from: parentNode.id, 
                        to: baseId+2, 
                        label: 'proposal', 
                        dashes: true, 
                        color: { color: '#ef4444' }, // Red for "Unverified/Proposed"
                        width: 1
                    });
                }

                network.fit();
                alert(`AI Architect: Analyzed "${topic}" via Maqasidic Framework.`);
            }, 1500);
        }

        function aiSimulateThinking() {
            const loader = document.getElementById('aiLoading');
            loader.classList.remove('hidden');
            setTimeout(() => {
                loader.classList.add('hidden');
                alert("Suggestion: This node lacks a connection to 'Ur' (Custom). Consider adding it.");
            }, 1000);
        }

        // 4. Export & Reset
        function exportImage() {
            const canvas = document.getElementById('mynetwork').getElementsByTagName('canvas')[0];
            const link = document.createElement('a');
            link.download = 'al-mizan-graph.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function resetGraph() {
            if(!network) return;
            network.fit({ 
                animation: {
                    duration: 1000,
                    easingFunction: 'easeInOutQuad'
                }
            });
            network.startSimulation();
        }

        // Initialize
        window.onload = init;

    </script>
</body>
</html>
